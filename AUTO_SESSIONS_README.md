# Авто-пересборка тренировок и напоминания

## Обзор

Система автоматически пересобирает будущие тренировочные сессии при изменении расписания групп, обеспечивая синхронизацию между `GroupSchedule` и `TrainingSession`.

## Компоненты

### 1. Сигналы (signals.py)

Автоматически срабатывают при изменении расписания:

```python
@receiver([post_save, post_delete], sender=GroupSchedule)
def on_schedule_change(sender, instance, **kwargs):
    """Любая правка расписания → пересчитать будущие незакрытые сессии этой группы"""
    resync_future_sessions_for_group(instance.training_group)
```

### 2. Утилиты (utils/sessions.py)

#### Основные функции:

- `month_bounds(d: date)` - границы месяца
- `ensure_month_sessions_for_group(group, target_date=None)` - создание сессий на месяц
- `resync_future_sessions_for_group(group)` - пересборка будущих сессий
- `ensure_next_month_sessions_for_group(group)` - создание сессий на следующий месяц
- `ensure_next_month_sessions_for_all_groups()` - массовое создание для всех групп
- `cleanup_old_sessions()` - очистка старых сессий

#### Логика работы:

1. **Удаление неактуальных сессий**: удаляются будущие незакрытые сессии, не соответствующие текущему расписанию
2. **Создание недостающих**: досоздаются сессии на остаток текущего месяца
3. **Только будущие**: прошлые и закрытые сессии не затрагиваются

### 3. Команда управления (generate_sessions.py)

#### Использование:

```bash
# Создать сессии на текущий месяц для всех групп
python manage.py generate_sessions

# Создать сессии на следующий месяц для всех групп
python manage.py generate_sessions --all-groups-next-month

# Создать сессии на следующий месяц для конкретной группы
python manage.py generate_sessions --group 1 --next-month

# Очистить старые сессии
python manage.py generate_sessions --cleanup

# Принудительно пересоздать все сессии
python manage.py generate_sessions --force
```

#### Для крона (1-е число месяца):

```bash
# Создать сессии на следующий месяц для всех групп
python manage.py generate_sessions --all-groups-next-month
```

### 4. Шаблоны напоминаний

#### AttendanceRecord:
- `change_list.html` - список записей с возможностью массового редактирования
- `change_form.html` - форма редактирования с информацией о спортсмене и тренировке

#### TrainingSession:
- `change_form.html` - форма редактирования с ссылкой на журнал посещаемости

## Принципы работы

### Автоматическая синхронизация

1. **Изменение расписания** → автоматический пересчет будущих сессий
2. **Только незакрытые** → закрытые сессии не изменяются
3. **Только будущие** → прошлые сессии не затрагиваются
4. **Атомарность** → все операции выполняются в транзакции

### Безопасность

- Проверка существования расписания перед созданием сессий
- Обработка ошибок с логированием
- Транзакционная целостность

## Настройка

### 1. Сигналы

Сигналы автоматически подключаются при импорте `core.signals`.

### 2. Шаблоны

Шаблоны автоматически подтягиваются Django через настройки `TEMPLATES`.

### 3. Медиа

Аватары спортсменов доступны через `MEDIA_URL` и `MEDIA_ROOT`.

## Мониторинг

### Логи

Все операции логируются в `AuditRecord`:
- Создание/изменение сессий
- Изменения расписания
- Ошибки синхронизации

### Команды

Используйте команду `generate_sessions` для:
- Проверки состояния сессий
- Принудительной синхронизации
- Очистки старых данных

## Примеры использования

### Сценарий 1: Изменение времени тренировки

1. Изменяете время в `GroupSchedule`
2. Сигнал автоматически срабатывает
3. Будущие сессии пересчитываются
4. Прошлые сессии остаются без изменений

### Сценарий 2: Добавление нового дня недели

1. Добавляете новый день в расписание
2. Сигнал создает сессии на этот день
3. Существующие сессии не затрагиваются

### Сценарий 3: Ежемесячное планирование

1. Крон запускает команду 1-го числа
2. Создаются сессии на следующий месяц
3. Система готова к работе

## Устранение неполадок

### Проблема: Сессии не создаются

**Решение:**
1. Проверьте наличие расписания у группы
2. Убедитесь, что группа не архивирована
3. Проверьте логи на ошибки

### Проблема: Сигналы не работают

**Решение:**
1. Убедитесь, что `core.signals` импортируется
2. Проверьте, что сигналы зарегистрированы
3. Перезапустите Django

### Проблема: Ошибки в админке

**Решение:**
1. Проверьте `list_filter` в админских классах
2. Убедитесь, что поля существуют в моделях
3. Проверьте консоль на ошибки

## Производительность

### Оптимизации:

- Массовые операции в транзакциях
- Фильтрация только нужных сессий
- Использование индексов по датам

### Мониторинг:

- Время выполнения команд
- Количество созданных/удаленных сессий
- Использование памяти

## Заключение

Система обеспечивает автоматическую синхронизацию тренировочных сессий с минимальным вмешательством администратора. Все изменения происходят автоматически, сохраняя целостность данных и историю тренировок.
