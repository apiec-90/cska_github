{% extends "admin/change_form.html" %}
{% block content %}
<style>
/* # Поднимаем модалку над оверлеем Jazzmin/Bootstrap */
.modal { z-index: 2050 !important; }
.modal-backdrop { z-index: 2000 !important; }
</style>
<div class="card w-100">
  <div class="card-body">
    <div class="row">
      <!-- Левая колонка: Аватар и данные тренера -->
      <div class="col-md-3">
        <div class="text-center">
          <!-- Вертикальный прямоугольник для аватара -->
          <div class="position-relative mb-3" style="width:200px;height:250px;margin:0 auto;border:2px dashed #dee2e6;border-radius:8px;overflow:hidden;cursor:pointer;" onclick="document.getElementById('avatar-upload').click();">
            {% if trainer_avatar_url %}
              <img src="{{ trainer_avatar_url }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;" class="img-fluid">
              <div class="position-absolute" style="top:5px;right:5px;">
                <span class="badge badge-success">✓</span>
              </div>
            {% else %}
              <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                <div>
                  <i class="fas fa-user fa-3x mb-2"></i>
                  <br><small>Нажмите для загрузки фото</small>
                </div>
              </div>
            {% endif %}
          </div>
          
          <!-- Форма загрузки аватара (скрытая) -->
          <form method="post" enctype="multipart/form-data" action="{% url 'admin:core_trainer_upload_avatar' object_id=original.id %}" style="display:none;">
            {% csrf_token %}
            <input type="file" id="avatar-upload" name="avatar" accept="image/*" onchange="this.form.submit();">
          </form>
          
          <!-- Отображение ФИО тренера -->
          <h5 class="card-title">
            <span id="display-full-name">
              {% if original.first_name or original.last_name %}
                {{ original.last_name }} {{ original.first_name }}
              {% else %}
                {{ original.user.last_name }} {{ original.user.first_name }}
              {% endif %}
            </span>
          </h5>
          
          <!-- Отображение телефона -->
          <p class="text-muted mb-1">
            <i class="fas fa-phone"></i> 
            <span id="display-phone">{{ original.phone|default:"Не указан" }}</span>
          </p>
          
          <!-- Отображение даты рождения -->
          <p class="text-muted mb-1">
            <i class="fas fa-birthday-cake"></i> 
            {{ original.birth_date|date:"d.m.Y"|default:"Не указана" }}
          </p>
          
          <!-- Статус пользователя -->
          <p class="mb-0">
            {% if original.user.is_active %}
              <span class="badge badge-success">Активен</span>
            {% else %}
              <span class="badge badge-danger">Неактивен</span>
            {% endif %}
          </p>
        </div>
      </div>
      
      <!-- Правая колонка: Группы тренера и документы -->
      <div class="col-md-9">
        <div class="row">
          <!-- Блок с группами тренера -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-users"></i> Группы тренера</h6>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if trainer_groups %}
                  {% for group in trainer_groups %}
                    <div class="border-bottom pb-2 mb-2">
                      <strong>{{ group.name }}</strong>
                      <br>
                      <small class="text-muted">
                        {% if group.is_active %}
                          <span class="badge badge-success">Активна</span>
                        {% else %}
                          <span class="badge badge-secondary">Неактивна</span>
                        {% endif %}
                      </small>
                      <br>
                      <small class="text-muted">
                        <i class="fas fa-calendar"></i> 
                        Возраст: {{ group.age_min }}-{{ group.age_max }} лет
                      </small>
                      <br>
                      <small class="text-muted">
                        <i class="fas fa-user-friends"></i> 
                        Спортсменов: {{ group.athletetraininggroup_set.count }}
                      </small>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="text-muted">Тренер не привязан к группам</p>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Блок с документами -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-file-alt"></i> Документы</h6>
                <button type="button" class="btn btn-light btn-sm" data-toggle="modal" data-target="#uploadDocumentModal">
                  <i class="fas fa-plus"></i> Добавить
                </button>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if trainer_documents %}
                  {% for doc in trainer_documents %}
                    <div class="border-bottom pb-2 mb-2 d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <strong>{{ doc.document_type.name }}</strong>
                        <br>
                        <small class="text-muted">
                          <i class="fas fa-calendar"></i> {{ doc.uploaded_at|date:"d.m.Y H:i" }}
                        </small>
                        <br>
                        <small class="text-muted">
                          <i class="fas fa-user"></i> {{ doc.uploaded_by.username }}
                        </small>
                        {% if doc.comment %}
                          <br>
                          <small class="text-muted">{{ doc.comment }}</small>
                        {% endif %}
                      </div>
                      <div class="btn-group btn-group-sm">
                        <a href="/media/{{ doc.file }}" target="_blank" class="btn btn-outline-primary btn-sm">
                          <i class="fas fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteDocument({{ doc.id }})">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="text-muted">Документы не загружены</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для загрузки документа -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Загрузить документ</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <form method="post" enctype="multipart/form-data" action="{% url 'admin:core_trainer_upload_document' object_id=original.id %}">
        <div class="modal-body">
          {% csrf_token %}
          <div class="form-group">
            <label for="document_type">Тип документа:</label>
            <select class="form-control" id="document_type" name="document_type">
              <option value="">Выберите тип документа</option>
              {% for doc_type in document_types %}
                <option value="{{ doc_type.id }}">{{ doc_type.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="document">Файл:</label>
            <input type="file" class="form-control-file" id="document" name="document" required>
          </div>
          <div class="form-group">
            <label for="comment">Комментарий:</label>
            <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Необязательный комментарий"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Загрузить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Скрытая форма для удаления документа -->
<form id="deleteDocumentForm" method="post" action="{% url 'admin:core_trainer_delete_document' object_id=original.id %}" style="display: none;">
  {% csrf_token %}
  <input type="hidden" id="deleteDocumentId" name="document_id">
</form>

<script>
function deleteDocument(documentId) {
  if (confirm('Вы уверены, что хотите удалить этот документ?')) {
    document.getElementById('deleteDocumentId').value = documentId;
    document.getElementById('deleteDocumentForm').submit();
  }
}

// Обновление отображения имени при изменении полей
document.addEventListener('DOMContentLoaded', function() {
  const firstNameField = document.querySelector('input[name="first_name"]');
  const lastNameField = document.querySelector('input[name="last_name"]');
  const phoneField = document.querySelector('input[name="phone"]');
  
  function updateDisplay() {
    // Обновляем ФИО
    const firstName = firstNameField ? firstNameField.value : '';
    const lastName = lastNameField ? lastNameField.value : '';
    const fullName = (lastName + ' ' + firstName).trim();
    
    const displayName = document.getElementById('display-full-name');
    if (displayName && fullName) {
      displayName.textContent = fullName;
    }
    
    // Обновляем телефон
    const phone = phoneField ? phoneField.value : '';
    const displayPhone = document.getElementById('display-phone');
    if (displayPhone) {
      displayPhone.textContent = phone || 'Не указан';
    }
  }
  
  if (firstNameField) firstNameField.addEventListener('input', updateDisplay);
  if (lastNameField) lastNameField.addEventListener('input', updateDisplay);
  if (phoneField) phoneField.addEventListener('input', updateDisplay);
});
</script>

{{ block.super }}
{% endblock %}

