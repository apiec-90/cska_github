{% extends "admin/change_form.html" %}
{% block content %}
<style>
/* # –ü–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞–¥ –æ–≤–µ—Ä–ª–µ–µ–º Jazzmin/Bootstrap */
.modal { z-index: 2050 !important; }
.modal-backdrop { z-index: 2000 !important; }
</style>
<div class="card w-100">
  <div class="card-body">
    <div class="row">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ê–≤–∞—Ç–∞—Ä –∏ –¥–∞–Ω–Ω—ã–µ —Ä–æ–¥–∏—Ç–µ–ª—è -->
      <div class="col-md-3">
        <div class="text-center">
          <!-- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ -->
          <div class="position-relative mb-3" style="width:200px;height:250px;margin:0 auto;border:2px dashed #dee2e6;border-radius:8px;overflow:hidden;cursor:pointer;" onclick="document.getElementById('avatar-upload').click();">
            <img id="avatar-preview" src="{% if parent_avatar_url %}{{ parent_avatar_url }}{% endif %}" alt="avatar" style="width:100%;height:100%;object-fit:cover;{% if not parent_avatar_url %}display:none;{% endif %}"/>
            <div id="avatar-placeholder" class="d-flex align-items-center justify-content-center h-100" style="background:#f8f9fa;{% if parent_avatar_url %}display:none;{% endif %}">
              <div class="text-center">
                <i class="fas fa-user" style="font-size:48px;color:#6c757d;"></i>
                <div class="mt-2 text-muted">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
              </div>
            </div>
            <!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <form id="avatar-form" action="{% url 'admin:core_parent_upload_avatar' original.pk %}" method="post" enctype="multipart/form-data" style="display:none;">
              {% csrf_token %}
              <input type="file" id="avatar-upload" name="avatar" accept="image/*" onchange="uploadAvatar(this);">
            </form>
          </div>
          
          <!-- –î–∞–Ω–Ω—ã–µ —Ä–æ–¥–∏—Ç–µ–ª—è -->
          <h5 class="mb-2">
            <span id="preview_name">{% if original.first_name or original.last_name %}{{ original.last_name|default:"" }} {{ original.first_name|default:"" }}{% elif original.user.first_name or original.user.last_name %}{{ original.user.last_name|default:"" }} {{ original.user.first_name|default:"" }}{% else %}{{ original.user.username }}{% endif %}</span>
          </h5>
          <div class="text-muted mb-2">
            <div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="preview_phone">{{ original.phone|default:"‚Äî" }}</span></div>
            <div><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span id="preview_birth">{{ original.birth_date|date:"d.m.Y"|default:"‚Äî" }}</span></div>
          </div>
          <span class="badge {% if original.user.is_active %}badge-success{% else %}badge-secondary{% endif %}">
            {% if original.user.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}
          </span>
        </div>
      </div>
      
      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–µ—Ç–∏, –≥—Ä—É–ø–ø—ã –¥–µ—Ç–µ–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
      <div class="col-md-9">
        <div class="row">
          <!-- –ë–ª–æ–∫ –¥–µ—Ç–µ–π -->
          <div class="col-md-6">
            <h6 class="mb-3"><strong>–î–µ—Ç–∏</strong></h6>
            {% if parent_children %}
              {% for relation in parent_children %}
                <div class="mb-3 p-3 border rounded">
                  <div class="d-flex align-items-center mb-2">
                    <div class="d-flex align-items-center justify-content-center rounded-circle me-3" style="width:40px;height:40px;background:#e9ecef;">
                      <strong>{{ relation.athlete.first_name|default:relation.athlete.user.first_name|default:relation.athlete.user.username|first|upper }}</strong>
                    </div>
                    <div class="flex-fill">
                      <div class="fw-bold">
                        {% if relation.athlete.first_name or relation.athlete.last_name %}
                          {{ relation.athlete.last_name|default:"" }} {{ relation.athlete.first_name|default:"" }}
                        {% elif relation.athlete.user.first_name or relation.athlete.user.last_name %}
                          {{ relation.athlete.user.last_name|default:"" }} {{ relation.athlete.user.first_name|default:"" }}
                        {% else %}
                          {{ relation.athlete.user.username }}
                        {% endif %}
                      </div>
                      {% if relation.athlete.phone %}
                        <small class="text-muted">{{ relation.athlete.phone }}</small>
                      {% endif %}
                      {% if relation.athlete.birth_date %}
                        <br><small class="text-muted">üìÖ {{ relation.athlete.birth_date|date:"d.m.Y" }}</small>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <em>–î–µ—Ç–µ–π –Ω–µ—Ç</em>
            {% endif %}
          </div>
          
          <!-- –ë–ª–æ–∫ –≥—Ä—É–ø–ø –¥–µ—Ç–µ–π -->
          <div class="col-md-6">
            <h6 class="mb-3"><strong>–ì—Ä—É–ø–ø—ã –¥–µ—Ç–µ–π</strong></h6>
            {% if parent_children %}
              {% for relation in parent_children %}
                {% for group_relation in relation.athlete.athletetraininggroup_set.all %}
                  <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="mb-0 text-primary">{{ group_relation.training_group.name }}</h6>
                      <span class="badge {% if group_relation.training_group.is_active %}badge-success{% else %}badge-secondary{% endif %}">
                        {% if group_relation.training_group.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}
                      </span>
                    </div>
                    
                    <div class="small text-muted">
                      <div><strong>–†–µ–±–µ–Ω–æ–∫:</strong> 
                        {% if relation.athlete.first_name or relation.athlete.last_name %}
                          {{ relation.athlete.last_name|default:"" }} {{ relation.athlete.first_name|default:"" }}
                        {% elif relation.athlete.user.first_name or relation.athlete.user.last_name %}
                          {{ relation.athlete.user.last_name|default:"" }} {{ relation.athlete.user.first_name|default:"" }}
                        {% else %}
                          {{ relation.athlete.user.username }}
                        {% endif %}
                      </div>
                      <div><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ group_relation.training_group.age_min }}-{{ group_relation.training_group.age_max }} –ª–µ—Ç</div>
                      <div><strong>–¢—Ä–µ–Ω–µ—Ä:</strong> 
                        {% if group_relation.training_group.trainer %}
                          {{ group_relation.training_group.trainer.user.last_name }} {{ group_relation.training_group.trainer.user.first_name }}
                          {% if group_relation.training_group.trainer.phone %}
                            <br><small class="text-muted">üìû {{ group_relation.training_group.trainer.phone }}</small>
                          {% endif %}
                        {% else %}
                          –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                        {% endif %}
                      </div>
                      <div><strong>–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤:</strong> {{ group_relation.training_group.get_athletes_count }}/{{ group_relation.training_group.max_athletes }}</div>
                      
                      <div class="mt-2"><strong>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</strong></div>
                      {% with schedules=group_relation.training_group.groupschedule_set.all %}
                        {% if schedules %}
                          {% for schedule in schedules %}
                            <div class="ms-2">
                              {% if schedule.weekday == 1 %}–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫{% elif schedule.weekday == 2 %}–í—Ç–æ—Ä–Ω–∏–∫{% elif schedule.weekday == 3 %}–°—Ä–µ–¥–∞{% elif schedule.weekday == 4 %}–ß–µ—Ç–≤–µ—Ä–≥{% elif schedule.weekday == 5 %}–ü—è—Ç–Ω–∏—Ü–∞{% elif schedule.weekday == 6 %}–°—É–±–±–æ—Ç–∞{% elif schedule.weekday == 7 %}–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ{% endif %}
                              {{ schedule.start_time|time:"H:i" }}-{{ schedule.end_time|time:"H:i" }}
                            </div>
                          {% endfor %}
                        {% else %}
                          <div class="ms-2">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                {% endfor %}
              {% endfor %}
            {% else %}
              <em>–î–µ—Ç–∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≥—Ä—É–ø–ø–∞–º</em>
            {% endif %}
          </div>
        </div>
        
        <!-- –ë–ª–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0"><strong>–î–æ–∫—É–º–µ–Ω—Ç—ã</strong></h6>
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal" data-toggle="modal" data-target="#addDocumentModal">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
              </button>
            </div>
            
            {% if parent_documents %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>–¢–∏–ø</th>
                      <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                      <th>–î–∞—Ç–∞</th>
                      <th width="120">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in parent_documents %}
                      <tr>
                        <td>{{ d.document_type.name|default:"–ü—Ä–æ—á–µ–µ" }}</td>
                        <td>{{ d.comment|default:"‚Äî" }}</td>
                        <td>{{ d.uploaded_at|date:"d.m.Y H:i" }}</td>
                        <td>
                          <div class="btn-group btn-group-sm" role="group">
                              <a href="{% if 'http' in d.file %}{{ d.file }}{% else %}/media/{{ d.file }}{% endif %}" target="_blank" class="btn btn-outline-primary" title="–û—Ç–∫—Ä—ã—Ç—å">
                                <i class="fas fa-eye"></i>
                              </a>
                            <button type="button" class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å" 
                                    data-document-id="{{ d.id }}" data-document-name="{{ d.document_type.name|default:"–¥–æ–∫—É–º–µ–Ω—Ç" }}">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-file-alt text-muted" style="font-size:48px;"></i>
                <p class="text-muted mt-2">–î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
<div class="modal fade" id="addDocumentModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h5>
        <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <form action="{% url 'admin:core_parent_upload_document' original.pk %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="document_type" class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
            <select name="document_type" id="document_type" class="form-select">
              <option value="">–ü—Ä–æ—á–µ–µ</option>
              {% for t in parent_document_types %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
            <input type="text" name="comment" id="comment" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞">
          </div>
          <div class="mb-3">
            <label for="document_file" class="form-label">–§–∞–π–ª:</label>
            <input type="file" name="document_file" id="document_file" class="form-control" required>
            <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
<form id="deleteDocumentForm" method="post" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="document_id" id="deleteDocumentId">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  document.querySelectorAll('[data-document-id]').forEach(function(button) {
    button.addEventListener('click', function() {
      var documentId = this.getAttribute('data-document-id');
      var documentName = this.getAttribute('data-document-name');
      
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç "' + documentName + '"?')) {
        document.getElementById('deleteDocumentId').value = documentId;
        document.getElementById('deleteDocumentForm').action = "{% url 'admin:core_parent_delete_document' original.pk %}";
        document.getElementById('deleteDocumentForm').submit();
      }
    });
  });

  // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –º–æ–¥–∞–ª–∫—É –≤ <body>, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å–æ stacking context
  try {
    var modal = document.getElementById('addDocumentModal');
    if (modal && modal.parentElement !== document.body) {
      document.body.appendChild(modal);
    }
  } catch (e) {}
});
</script>

<script>
// –ñ–∏–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã
(function() {
  function qs(sel){return document.querySelector(sel)}
  function qsv(sel){var el=qs(sel);return el?el.value.trim():""}
  function setText(id, text){var el=document.getElementById(id);if(el){el.textContent=text||"‚Äî"}}
  function formatDateYmdToDmY(ymd){ if(!ymd) return "‚Äî"; var p=ymd.split('-'); if(p.length!==3) return ymd; return p[2]+'.'+p[1]+'.'+p[0]; }

  function updatePreview(){
    // –ò—â–µ–º –ø–æ–ª—è –§–ò–û –≤ –º–æ–¥–µ–ª–∏ Parent (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –∏–ª–∏ User
    var first = qsv('input[name="first_name"], input[name="user__first_name"], input[name="user-first_name"], #id_first_name');
    var last = qsv('input[name="last_name"], input[name="user__last_name"], input[name="user-last_name"], #id_last_name');
    var phone = qsv('input[name="phone"], #id_phone');
    var birth = qsv('input[name="birth_date"], #id_birth_date');

    setText('preview_name', (last+" "+first).trim());
    setText('preview_phone', phone || '‚Äî');
    setText('preview_birth', formatDateYmdToDmY(birth));
  }

  document.addEventListener('input', function(e){
    if (e.target && (e.target.name||'').match(/first_name|last_name|phone|birth_date/)) {
      updatePreview();
    }
  });
  document.addEventListener('change', function(e){
    if (e.target && (e.target.name||'').match(/birth_date/)) {
      updatePreview();
    }
  });
  document.addEventListener('DOMContentLoaded', updatePreview);
})();

// AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ (–∫–æ–ø–∏—è –∏–∑ athlete)
async function uploadAvatar(input) {
  if (!input.files || !input.files[0]) return;
  
  const formData = new FormData();
  formData.append('avatar', input.files[0]);
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
  
  try {
    const response = await fetch(input.form.action, {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('avatar-preview').src = e.target.result;
        document.getElementById('avatar-preview').style.display = 'block';
        document.getElementById('avatar-placeholder').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', error);
  }
}
</script>

{{ block.super }}
{% endblock %}














