{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify admin_extras custom_filters %}

{% block title %}Журнал группы: {{ group.name }}{% endblock %}

{% block extrastyle %}
<style>
  table.journal{border-collapse:collapse;width:100%}
  table.journal th,table.journal td{border:1px solid #ddd;padding:6px;text-align:center}
  th.sticky,td.child{position:sticky;left:0;background:#fff;text-align:left}
  .muted{opacity:.5}
  .today{font-weight:600}
</style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
<p>
  <a class="button" href="{% url 'admin:core_traininggroup_change' group.pk %}">Назад к группе</a>
  {% if edit_mode %}
    <a class="button" href="{% url 'admin:core_traininggroup_journal' group.pk %}">Выйти из редактирования</a>
  {% else %}
    <a class="button" href="{% url 'admin:core_traininggroup_journal' group.pk %}?edit=1">Редактировать</a>
  {% endif %}
</p>

<form method="post">
  {% csrf_token %}
  <table class="journal">
    <thead>
      <tr>
        <th class="sticky">Спортсмен</th>
        {% for s in sessions %}
          <th class="{% if s.date == today %}today{% else %}muted{% endif %}">
            {{ s.date }}<br>{{ s.start_time|default_if_none:"" }}
            {% if s.is_closed %}<div class="muted">закрыта</div>{% endif %}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for a in athletes %}
        <tr>
          <td class="child">
            {% if a.photo %}<img src="{{ a.photo.url }}" style="width:22px;height:22px;border-radius:50%;vertical-align:middle;margin-right:6px;">{% endif %}
            <a href="{% url 'admin:core_athlete_change' a.pk %}">{{ a.last_name }} {{ a.first_name }}</a>
          </td>
          {% for s in sessions %}
            <td class="{% if not edit_mode and s.date != today %}muted{% endif %}">
              {% if edit_mode or (s.date == today and not s.is_closed) %}
                {# ключ = sid + aid; генерим во view #}
                <input type="checkbox" name="pk" value="{{ s.date }}_{{ s.start_time }}_{{ a.id }}"
                       {% if s.date|date:"Y-m-d"|add:"_"|add:s.start_time|time:"H:i" in present and a.id in present|get_item:s.date|date:"Y-m-d"|add:"_"|add:s.start_time|time:"H:i" %}checked{% endif %}>
              {% else %}
                {% if s.date|date:"Y-m-d"|add:"_"|add:s.start_time|time:"H:i" in present and a.id in present|get_item:s.date|date:"Y-m-d"|add:"_"|add:s.start_time|time:"H:i" %}✅{% else %}❌{% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top:12px">
    <button class="button default" type="submit">
      {% if edit_mode %}Сохранить журнал{% else %}Сохранить и закрыть сегодняшнюю сессию{% endif %}
    </button>
  </div>
</form>
{% endblock %}
