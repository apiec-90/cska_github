<!DOCTYPE html>
<html>
<head>
    <title>Test Checkboxes</title>
    <style>
        .attendance-checkbox-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 50px;
            cursor: pointer;
            border: 1px solid #ccc;
            margin: 10px;
        }
        
        .attendance-checkbox {
            width: 24px;
            height: 24px;
        }
        
        .edit-mode-indicator {
            background: orange;
            color: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç —á–µ–∫–±–æ–∫—Å–æ–≤</h1>
    
    <div class="edit-mode-indicator">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
    
    <div class="attendance-checkbox-wrapper" data-session="1" data-athlete="1" data-editable="true">
        <input type="checkbox" class="attendance-checkbox" data-session="1" data-athlete="1">
    </div>
    
    <div class="attendance-checkbox-wrapper" data-session="2" data-athlete="1" data-editable="true">
        <input type="checkbox" class="attendance-checkbox" data-session="2" data-athlete="1" checked>
    </div>
    
    <div class="attendance-checkbox-wrapper" data-session="3" data-athlete="2" data-editable="false">
        <input type="checkbox" class="attendance-checkbox" data-session="3" data-athlete="2">
    </div>
    
    <div id="changes-counter">–ò–∑–º–µ–Ω–µ–Ω–∏–π: 0</div>
    <button id="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    
    <script>
    class UnifiedJournalContext {
      constructor() {
        this.state = {
          changes: new Map(),
          isLoading: false,
          editMode: true,
          notifications: []
        };
        this.subscribers = [];
      }

      subscribe(callback) {
        this.subscribers.push(callback);
        return () => {
          this.subscribers = this.subscribers.filter(sub => sub !== callback);
        };
      }

      notify() {
        this.subscribers.forEach(callback => callback(this.state));
      }

      setState(updates) {
        this.state = { ...this.state, ...updates };
        this.notify();
      }

      addChange(sessionId, athleteId, isPresent) {
        const key = `${sessionId}_${athleteId}`;
        const newChanges = new Map(this.state.changes);
        
        newChanges.set(key, {
          session_id: parseInt(sessionId),
          athlete_id: parseInt(athleteId),
          present: isPresent
        });
        
        this.setState({ changes: newChanges });
        console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ:', sessionId, athleteId, isPresent, '–í—Å–µ–≥–æ:', newChanges.size);
      }

      clearChanges() {
        this.setState({ changes: new Map() });
      }
    }

    class UnifiedJournalApp {
      constructor() {
        this.context = new UnifiedJournalContext();
        this.elements = {
          changesCounter: document.getElementById('changes-counter'),
          saveButton: document.getElementById('save-button')
        };
        
        this.init();
      }

      init() {
        this.context.subscribe((state) => {
          this.updateUI(state);
        });

        this.updateUI(this.context.state);
        this.setupEventListeners();
        
        console.log('üìã –ñ—É—Ä–Ω–∞–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log(`üîß –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${this.context.state.editMode ? '–í–ö–õ' : '–í–´–ö–õ'}`);
      }

      setupEventListeners() {
        console.log('üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ event listeners...');
        
        const checkboxWrappers = document.querySelectorAll('.attendance-checkbox-wrapper');
        console.log('üî• –ù–∞–π–¥–µ–Ω–æ —á–µ–∫–±–æ–∫—Å–æ–≤:', checkboxWrappers.length);
        
        checkboxWrappers.forEach((wrapper, index) => {
          const sessionId = wrapper.getAttribute('data-session');
          const athleteId = wrapper.getAttribute('data-athlete');
          
          console.log(`üî• –ß–µ–∫–±–æ–∫—Å ${index}: session=${sessionId}, athlete=${athleteId}`);
          
          wrapper.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üî• –ö–ª–∏–∫ –ø–æ —á–µ–∫–±–æ–∫—Å—É:', sessionId, athleteId);
            
            if (sessionId && athleteId) {
              this.toggleAttendance(sessionId, athleteId, wrapper);
            }
          });
        });

        if (this.elements.saveButton) {
          this.elements.saveButton.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞!');
          });
        }
        
        console.log('üî• Event listeners –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
      }

      updateUI(state) {
        const changesCount = state.changes.size;
        
        if (this.elements.changesCounter) {
          this.elements.changesCounter.textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–π: ${changesCount}`;
        }
        
        if (changesCount > 0) {
          if (this.elements.saveButton) {
            this.elements.saveButton.disabled = false;
            this.elements.saveButton.textContent = `üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ${changesCount} –∏–∑–º–µ–Ω–µ–Ω–∏–π`;
          }
        } else {
          if (this.elements.saveButton) {
            this.elements.saveButton.disabled = true;
            this.elements.saveButton.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
          }
        }
      }

      toggleAttendance(sessionId, athleteId, element) {
        const checkbox = element.querySelector('.attendance-checkbox');
        
        if (!checkbox) {
          console.error('‚ùå –ß–µ–∫–±–æ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          return;
        }
        
        console.log('üî• toggleAttendance –≤—ã–∑–≤–∞–Ω:', {
          sessionId,
          athleteId,
          editMode: this.context.state.editMode,
          checkboxDisabled: checkbox.disabled,
          dataEditable: element.getAttribute('data-editable')
        });
        
        // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ
        if (this.context.state.editMode) {
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          const newState = !checkbox.checked;
          
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          checkbox.checked = newState;
          
          // –£–±–∏—Ä–∞–µ–º disabled —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          checkbox.disabled = false;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
          this.context.addChange(sessionId, athleteId, newState);

          // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
          element.style.transform = 'scale(0.95)';
          setTimeout(() => {
            element.style.transform = 'scale(1)';
          }, 150);

          console.log(`‚úÖ –û—Ç–º–µ—Ç–∫–∞: —Å–ø–æ—Ä—Ç—Å–º–µ–Ω ${athleteId}, —Å–µ—Å—Å–∏—è ${sessionId}, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ: ${newState}`);
          return;
        }
        
        // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        const isEditable = element.getAttribute('data-editable') === 'true';
        
        if (!isEditable) {
          alert('–≠—Ç–∞ —Å–µ—Å—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
          return;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const newState = !checkbox.checked;
        checkbox.checked = newState;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        this.context.addChange(sessionId, athleteId, newState);

        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        element.style.transform = 'scale(0.95)';
        setTimeout(() => {
          element.style.transform = 'scale(1)';
        }, 150);

        console.log(`‚úÖ –û—Ç–º–µ—Ç–∫–∞: —Å–ø–æ—Ä—Ç—Å–º–µ–Ω ${athleteId}, —Å–µ—Å—Å–∏—è ${sessionId}, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ: ${newState}`);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      try {
        window.UnifiedJournal = new UnifiedJournalApp();
        console.log('‚úÖ –ñ—É—Ä–Ω–∞–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
      }
    });
    </script>
</body>
</html>


