{% extends "admin/base_site.html" %}
{% load custom_filters %}

{% block extrastyle %}
<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --danger-color: #f44336;
  --warning-color: #ff9800;
  --success-color: #4CAF50;
  --info-color: #17a2b8;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ */
.journal-container {
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow);
  overflow: hidden;
  margin: 20px 0;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
.journal-header {
  background: linear-gradient(135deg, var(--primary-color), #45a049);
  color: white;
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.journal-title {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
}

.journal-subtitle {
  margin: 5px 0 0 0;
  opacity: 0.9;
  font-size: 14px;
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.back-btn {
  color: white;
  text-decoration: none;
  padding: 8px 16px;
  background: rgba(255,255,255,0.2);
  border-radius: 6px;
  transition: var(--transition);
}

.back-btn:hover {
  background: rgba(255,255,255,0.3);
  color: white;
  text-decoration: none;
}

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º */
.month-navigation {
  background: var(--light-bg);
  padding: 20px 30px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.month-nav-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
}

.month-btn {
  background: var(--secondary-color);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: var(--transition);
  text-decoration: none;
  display: inline-block;
}

.month-btn:hover {
  background: #1976d2;
  color: white;
  text-decoration: none;
  transform: translateY(-1px);
}

.month-btn.current {
  background: var(--primary-color);
}

.month-title {
  font-size: 18px;
  font-weight: 600;
  color: #495057;
  margin: 0;
}

.month-selector {
  display: flex;
  gap: 5px;
  align-items: center;
}

.month-dropdown {
  padding: 6px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: white;
  font-size: 14px;
}

/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.control-panel {
  padding: 20px 30px;
  background: white;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.control-info {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.info-badge {
  background: var(--info-color);
  color: white;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: 600;
}

.changes-counter {
  background: var(--secondary-color);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 14px;
  transition: var(--transition);
}

.changes-counter.has-changes {
  background: var(--warning-color);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.control-actions {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.action-btn {
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.action-btn.primary {
  background: var(--primary-color);
  color: white;
}

.action-btn.secondary {
  background: var(--secondary-color);
  color: white;
}

.action-btn.warning {
  background: var(--warning-color);
  color: white;
}

.action-btn.danger {
  background: var(--danger-color);
  color: white;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  text-decoration: none;
  color: white;
}

.action-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
.edit-mode-indicator {
  background: var(--warning-color);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.edit-mode-indicator::before {
  content: "‚úèÔ∏è";
}

/* –¢–∞–±–ª–∏—Ü–∞ */
.attendance-table-wrapper {
  overflow-x: auto;
  max-height: 70vh;
  position: relative;
}

.attendance-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: white;
}

.attendance-table thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

.attendance-table th {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  color: #495057;
  white-space: nowrap;
}

.attendance-table th.athlete-name {
  text-align: left;
  min-width: 180px;
  position: sticky;
  left: 0;
  background: var(--light-bg);
  z-index: 11;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

.attendance-table td {
  border: 1px solid var(--border-color);
  padding: 0;
  text-align: center;
  position: relative;
}

.attendance-table td.athlete-name {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  background: white;
  position: sticky;
  left: 0;
  z-index: 9;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

/* –Ø—á–µ–π–∫–∏ —Å–µ—Å—Å–∏–π —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ */
.session-cell {
  position: relative;
  min-height: 50px;
}

.session-cell.active {
  background: rgba(76, 175, 80, 0.1);
  border: 2px solid var(--primary-color);
}

.session-cell.closed {
  background: rgba(108, 117, 125, 0.1);
}

.session-cell.future {
  background: rgba(255, 193, 7, 0.05);
}

.session-cell.past {
  background: rgba(220, 53, 69, 0.05);
}

.session-cell.canceled {
  background: rgba(220, 53, 69, 0.2);
  position: relative;
}

.session-cell.canceled::after {
  content: "‚ùå";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 20px;
  z-index: 5;
}

/* –ß–µ–∫–±–æ–∫—Å—ã - –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
.attendance-checkbox-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 50px;
  transition: var(--transition);
  position: relative;
}

/* –ö–ê–°–¢–û–ú–ù–´–ï –ß–ï–ö–ë–û–ö–°–´ –ë–ï–ó –ö–û–ù–§–õ–ò–ö–¢–û–í */
.custom-checkbox {
  width: 24px;
  height: 24px;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}

.custom-checkbox .checkmark {
  color: white;
  font-weight: bold;
  font-size: 16px;
  opacity: 0;
  transform: scale(0);
  transition: all 0.2s ease;
}

/* –°–û–°–¢–û–Ø–ù–ò–ï CHECKED */
.custom-checkbox.checked {
  background: #4CAF50 !important;
  border-color: #4CAF50 !important;
}

.custom-checkbox.checked .checkmark {
  opacity: 1 !important;
  transform: scale(1) !important;
}

/* –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê - –í–°–ï –û–¢–ö–õ–Æ–ß–ï–ù–û */
.journal-container:not(.edit-mode) .custom-checkbox {
  cursor: not-allowed !important;
  opacity: 0.4 !important;
  pointer-events: none !important;
}

.journal-container:not(.edit-mode) .custom-checkbox.checked {
  background: #6c757d !important;
  border-color: #6c757d !important;
}

/* –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø - –í–°–ï –ê–ö–¢–ò–í–ù–û */
.journal-container.edit-mode .custom-checkbox {
  cursor: pointer !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

.journal-container.edit-mode .custom-checkbox:hover {
  border-color: #4CAF50;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
  transform: scale(1.05);
}

/* –ê–ù–ò–ú–ê–¶–ò–ò –ö–õ–ò–ö–ê */
.custom-checkbox.clicked {
  transform: scale(0.9) !important;
}

.custom-checkbox.bounce {
  transform: scale(1.1) !important;
  transition: transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
}

/* –û–±–µ—Ä—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ */
.attendance-checkbox-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 50px;
  transition: var(--transition);
  position: relative;
}

.journal-container.edit-mode .attendance-checkbox-wrapper:hover {
  background: rgba(76, 175, 80, 0.1);
}

/* –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã */
.journal-container:not(.edit-mode) .attendance-checkbox-wrapper {
  cursor: not-allowed;
  opacity: 0.4;
  pointer-events: none;
}

.journal-container:not(.edit-mode) .attendance-checkbox {
  cursor: not-allowed;
  opacity: 0.4;
  background: #f8f9fa !important;
  border-color: #dee2e6 !important;
  pointer-events: none;
}

.journal-container:not(.edit-mode) .attendance-checkbox:checked {
  background: #6c757d !important;
  border-color: #6c757d !important;
}

/* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∞–∫—Ç–∏–≤–Ω—ã */
.journal-container.edit-mode .attendance-checkbox-wrapper {
  cursor: pointer;
  opacity: 1;
  pointer-events: auto;
}

.journal-container.edit-mode .attendance-checkbox {
  cursor: pointer;
  opacity: 1;
  pointer-events: auto;
  background: white;
  border-color: #ddd;
}

.journal-container.edit-mode .attendance-checkbox-wrapper:hover {
  background: rgba(76, 175, 80, 0.1);
}

.journal-container.edit-mode .attendance-checkbox:hover {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
  transform: scale(1.05);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å */
.attendance-checkbox.clicked {
  transform: scale(0.9);
  transition: transform 0.1s ease;
}

.attendance-checkbox.clicked.bounce {
  transform: scale(1.1);
  transition: transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

 .attendance-checkbox:checked {
   background: var(--primary-color) !important;
   border-color: var(--primary-color) !important;
 }

 .attendance-checkbox:checked::after {
   content: '‚úì' !important;
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   color: white !important;
   font-weight: bold;
   font-size: 16px;
 }

/* –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã —Ç–æ–∂–µ –∑–∞—Ç–µ–º–Ω–µ–Ω—ã */
.attendance-checkbox[data-editable="false"]:checked {
  background: #6c757d !important;
  border-color: #6c757d !important;
}

.attendance-checkbox:not([data-editable="false"]):hover {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ—Å—Å–∏–π */
.session-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: 70px;
  padding: 8px 4px;
}

.session-date {
  font-weight: 600;
  color: #495057;
  font-size: 12px;
}

.session-time {
  font-size: 10px;
  color: #6c757d;
}

.session-status {
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 500;
  margin-top: 2px;
}

.session-status.active {
  background: var(--primary-color);
  color: white;
}

.session-status.closed {
  background: #6c757d;
  color: white;
}

.session-status.future {
  background: var(--warning-color);
  color: white;
}

.session-status.past {
  background: var(--info-color);
  color: white;
}

.session-status.canceled {
  background: var(--danger-color);
  color: white;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.statistics-panel {
  background: var(--light-bg);
  padding: 15px 30px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: space-around;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
}

.stat-item {
  text-align: center;
}

.stat-number {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary-color);
  display: block;
}

.stat-label {
  font-size: 12px;
  color: #6c757d;
  margin-top: 4px;
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  z-index: 1000;
  transform: translateX(400px);
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow);
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: var(--success-color);
}

.notification.error {
  background: var(--danger-color);
}

.notification.warning {
  background: var(--warning-color);
}

.notification.info {
  background: var(--info-color);
}

/* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
  .journal-header {
    padding: 15px 20px;
    flex-direction: column;
    align-items: stretch;
  }
  
  .journal-title {
    font-size: 20px;
  }
  
  .month-navigation, .control-panel {
    padding: 15px 20px;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  
  .control-info {
    justify-content: center;
  }
  
  .attendance-table th.athlete-name {
    min-width: 120px;
  }
  
  .session-header {
    min-width: 50px;
    padding: 6px 2px;
  }
  
  .statistics-panel {
    padding: 15px 20px;
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ */
.attendance-checkbox-wrapper[data-editable="false"] {
  opacity: 0.6;
  cursor: not-allowed;
}

.attendance-checkbox-wrapper[data-editable="false"] .attendance-checkbox {
  cursor: not-allowed;
}

.attendance-checkbox-wrapper[data-editable="false"]:hover {
  opacity: 0.6;
}

.attendance-checkbox-wrapper[data-editable="false"] .attendance-checkbox:disabled {
  opacity: 0.4;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="journal-container{% if edit_mode %} edit-mode{% endif %}">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="journal-header">
    <div>
      <h1 class="journal-title">üìã {{ title }}</h1>
      <p class="journal-subtitle">–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏</p>
    </div>
    <div class="header-actions">
      <a href="{% url 'admin:core_traininggroup_panel' group.pk %}" class="back-btn">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–µ
      </a>
    </div>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
  <div class="month-navigation">
    <div class="month-nav-buttons">
      <a href="?year={{ month_nav.prev.year }}&month={{ month_nav.prev.month }}" class="month-btn">
        ‚Üê {{ month_nav.prev.name }}
      </a>
      <h2 class="month-title">{{ month_nav.current.name }} {{ month_nav.current.year }}</h2>
      <a href="?year={{ month_nav.next.year }}&month={{ month_nav.next.month }}" class="month-btn">
        {{ month_nav.next.name }} ‚Üí
      </a>
    </div>
    
    <div class="month-selector">
      <select class="month-dropdown" onchange="navigateToMonth(this.value)">
        {% for month_item in month_nav.available_months %}
        <option value="{{ month_item.year }}-{{ month_item.month }}" 
                {% if month_item.month == month_nav.current.month %}selected{% endif %}>
          {{ month_item.name }} {{ month_item.year }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="control-panel">
    <div class="control-info">
      <div class="info-badge">
        –°–µ—Å—Å–∏–π: {{ statistics.total }}
      </div>
      <div class="changes-counter" id="changes-counter">
        –ò–∑–º–µ–Ω–µ–Ω–∏–π: 0
      </div>
      {% if edit_mode %}
      <div class="edit-mode-indicator">
        –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      </div>
      {% endif %}
    </div>
    
    <div class="control-actions">
      <a href="?year={{ current_year }}&month={{ current_month }}&edit=1" class="action-btn warning" id="edit-mode-btn">
        ‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      </a>
      
      <button class="action-btn primary" id="save-button" disabled>
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      </button>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
  <div class="attendance-table-wrapper">
    <table class="attendance-table" id="attendance-table">
      <thead>
        <tr>
          <th class="athlete-name">üë§ –°–ø–æ—Ä—Ç—Å–º–µ–Ω</th>
          {% for session in sessions %}
          <th class="session-cell {{ session.state }}{% if session.is_canceled %} canceled{% endif %}">
            <div class="session-header">
              <div class="session-date">{{ session.date|date:"d.m" }}</div>
              <div class="session-time">{{ session.start_time|time:"H:i" }}</div>
              <div class="session-status {{ session.state }}{% if session.is_canceled %} canceled{% endif %}">
                {% if session.is_canceled %}
                  –û—Ç–º–µ–Ω–µ–Ω–∞
                {% elif session.state == 'active' %}
                  –ò–¥–µ—Ç —Å–µ–π—á–∞—Å
                {% elif session.state == 'closed' %}
                  –ó–∞–∫—Ä—ã—Ç–∞
                {% elif session.state == 'future' %}
                  –ë—É–¥—É—â–∞—è
                {% elif session.state == 'past' %}
                  –ü—Ä–æ—à–ª–∞
                {% endif %}
              </div>
            </div>
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for athlete in children %}
        <tr>
          <td class="athlete-name">
            {{ athlete.last_name }} {{ athlete.first_name }}
          </td>
          {% for session in sessions %}
          {% with session_present=present|lookup:session.id %}
          <td class="session-cell {{ session.state }}{% if session.is_canceled %} canceled{% endif %}">
            {% if not session.is_canceled %}
            <div class="attendance-checkbox-wrapper" 
                 data-session="{{ session.id }}"
                 data-athlete="{{ athlete.id }}">
              <!-- –ö–ê–°–¢–û–ú–ù–´–ô –ß–ï–ö–ë–û–ö–° –ë–ï–ó INPUT -->
              <div class="custom-checkbox"
                   data-session="{{ session.id }}"
                   data-athlete="{{ athlete.id }}"
                   data-checked="{% if session_present and athlete.id in session_present %}true{% else %}false{% endif %}">
                <span class="checkmark">‚úì</span>
              </div>
            </div>
            {% endif %}
          </td>
          {% endwith %}
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="statistics-panel">
    <div class="stat-item">
      <span class="stat-number">{{ statistics.total }}</span>
      <div class="stat-label">–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</div>
    </div>
    <div class="stat-item">
      <span class="stat-number">{{ statistics.active }}</span>
      <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
    </div>
    <div class="stat-item">
      <span class="stat-number">{{ statistics.closed }}</span>
      <div class="stat-label">–ó–∞–∫—Ä—ã—Ç—ã—Ö</div>
    </div>
    <div class="stat-item">
      <span class="stat-number">{{ statistics.future }}</span>
      <div class="stat-label">–ë—É–¥—É—â–∏—Ö</div>
    </div>
    <div class="stat-item">
      <span class="stat-number">{{ statistics.canceled }}</span>
      <div class="stat-label">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö</div>
    </div>
  </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification" class="notification"></div>

<!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
<div id="loading-overlay" class="loading-overlay">
  <div class="spinner"></div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

// –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π Context API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∂—É—Ä–Ω–∞–ª–∞
class UnifiedJournalContext {
  constructor() {
    this.state = {
      changes: new Map(),
      isLoading: false,
      editMode: false,
      currentYear: 2025,
      currentMonth: 8,
      notifications: []
    };
    this.subscribers = [];
  }

  subscribe(callback) {
    this.subscribers.push(callback);
    return () => {
      this.subscribers = this.subscribers.filter(sub => sub !== callback);
    };
  }

  notify() {
    this.subscribers.forEach(callback => callback(this.state));
  }

  setState(updates) {
    this.state = { ...this.state, ...updates };
    this.notify();
  }

  addChange(sessionId, athleteId, isPresent) {
    const key = `${sessionId}_${athleteId}`;
    const newChanges = new Map(this.state.changes);
    
    newChanges.set(key, {
      session_id: parseInt(sessionId),
      athlete_id: parseInt(athleteId),
      present: isPresent
    });
    
    this.setState({ changes: newChanges });
    console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ:', sessionId, athleteId, isPresent, '–í—Å–µ–≥–æ:', newChanges.size);
  }

  clearChanges() {
    this.setState({ changes: new Map() });
  }

  setLoading(isLoading) {
    this.setState({ isLoading });
  }

  addNotification(message, type = 'info') {
    const notification = {
      id: Date.now(),
      message,
      type,
      timestamp: new Date()
    };
    
    const notifications = [...this.state.notifications, notification];
    this.setState({ notifications });
    
    setTimeout(() => {
      this.removeNotification(notification.id);
    }, 5000);
    
    return notification.id;
  }

  removeNotification(id) {
    const notifications = this.state.notifications.filter(n => n.id !== id);
    this.setState({ notifications });
  }
}

// –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞
class UnifiedJournalApp {
  constructor() {
    this.context = new UnifiedJournalContext();
    this.elements = {
      changesCounter: document.getElementById('changes-counter'),
      saveButton: document.getElementById('save-button'),
      notification: document.getElementById('notification'),
      loadingOverlay: document.getElementById('loading-overlay'),
      table: document.getElementById('attendance-table')
    };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
    console.log('üî• Elements check:', {
      changesCounter: !!this.elements.changesCounter,
      saveButton: !!this.elements.saveButton,
      notification: !!this.elements.notification,
      loadingOverlay: !!this.elements.loadingOverlay,
      table: !!this.elements.table
    });
    
    this.init();
  }

  init() {
    this.context.subscribe((state) => {
      this.updateUI(state);
    });

    this.updateUI(this.context.state);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    this.setupEventListeners();
    
    console.log('üìã –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω');
    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${document.querySelectorAll('.attendance-checkbox').length} —á–µ–∫–±–æ–∫—Å–æ–≤`);
    console.log(`üîß –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${this.context.state.editMode ? '–í–ö–õ' : '–í–´–ö–õ'}`);
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
    setTimeout(() => {
      console.log('üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É:');
      console.log('üî• –ß–µ–∫–±–æ–∫—Å—ã:', document.querySelectorAll('.attendance-checkbox').length);
      console.log('üî• Wrappers:', document.querySelectorAll('.attendance-checkbox-wrapper').length);
      console.log('üî• Edit mode:', this.context.state.editMode);
    }, 1000);
  }

  setupEventListeners() {
    console.log('üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ event listeners...');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ö–ê–°–¢–û–ú–ù–´–• —á–µ–∫–±–æ–∫—Å–æ–≤
    const customCheckboxes = document.querySelectorAll('.custom-checkbox');
    console.log('üî• –ù–∞–π–¥–µ–Ω–æ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤:', customCheckboxes.length);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    customCheckboxes.forEach((checkbox, index) => {
      const isChecked = checkbox.getAttribute('data-checked') === 'true';
      if (isChecked) {
        checkbox.classList.add('checked');
      }
      console.log(`üî• –ö–∞—Å—Ç–æ–º —á–µ–∫–±–æ–∫—Å ${index}: checked=${isChecked}`);
    });
    
    customCheckboxes.forEach((checkbox, index) => {
      const sessionId = checkbox.getAttribute('data-session');
      const athleteId = checkbox.getAttribute('data-athlete');
      
      console.log(`üî• –ö–∞—Å—Ç–æ–º —á–µ–∫–±–æ–∫—Å ${index}: session=${sessionId}, athlete=${athleteId}`);
      
      // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      if (checkbox._clickHandler) {
        checkbox.removeEventListener('click', checkbox._clickHandler);
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      checkbox._clickHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isEditMode = document.querySelector('.journal-container.edit-mode') !== null;
        
        console.log('üî• –ö–ª–∏–∫ –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É —á–µ–∫–±–æ–∫—Å—É:', {
          sessionId, 
          athleteId, 
          editMode: isEditMode
        });
        
        if (!isEditMode) {
          this.showNotification('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏', 'warning');
          return;
        }
        
        if (sessionId && athleteId) {
          this.toggleCustomCheckbox(sessionId, athleteId, checkbox);
        }
      };
      
      checkbox.addEventListener('click', checkbox._clickHandler);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    if (this.elements.saveButton) {
      this.elements.saveButton.addEventListener('click', (e) => {
        e.preventDefault();
        this.saveChanges();
      });
    }
    
    console.log('üî• Event listeners –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  }

  updateUI(state) {
    // –°—á–µ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const changesCount = state.changes.size;
    
    if (this.elements.changesCounter) {
      this.elements.changesCounter.textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–π: ${changesCount}`;
    }
    
    if (changesCount > 0) {
      if (this.elements.changesCounter) {
        this.elements.changesCounter.classList.add('has-changes');
      }
      if (this.elements.saveButton) {
        this.elements.saveButton.disabled = false;
        this.elements.saveButton.textContent = `üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ${changesCount} –∏–∑–º–µ–Ω–µ–Ω–∏–π`;
      }
    } else {
      if (this.elements.changesCounter) {
        this.elements.changesCounter.classList.remove('has-changes');
      }
      if (this.elements.saveButton) {
        this.elements.saveButton.disabled = true;
        this.elements.saveButton.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      }
    }

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    if (this.elements.loadingOverlay) {
      if (state.isLoading) {
        this.elements.loadingOverlay.classList.add('show');
      } else {
        this.elements.loadingOverlay.classList.remove('show');
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    state.notifications.forEach(notification => {
      if (!notification.shown) {
        this.showNotification(notification.message, notification.type);
        notification.shown = true;
      }
    });
  }

  toggleCustomCheckbox(sessionId, athleteId, checkbox) {
    console.log('üî• toggleCustomCheckbox:', {
      sessionId,
      athleteId,
      currentChecked: checkbox.classList.contains('checked')
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const isEditMode = document.querySelector('.journal-container.edit-mode') !== null;
    
    if (!isEditMode) {
      this.showNotification('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏', 'warning');
      return;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const isCurrentlyChecked = checkbox.classList.contains('checked');
    const newState = !isCurrentlyChecked;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
    checkbox.classList.add('clicked');
    const wrapper = checkbox.closest('.attendance-checkbox-wrapper');
    if (wrapper) {
      wrapper.style.transform = 'scale(0.95)';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (newState) {
      checkbox.classList.add('checked');
      checkbox.setAttribute('data-checked', 'true');
    } else {
      checkbox.classList.remove('checked');
      checkbox.setAttribute('data-checked', 'false');
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç
    this.context.addChange(sessionId, athleteId, newState);

    // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç—Å–∫–æ–∫–∞
    setTimeout(() => {
      checkbox.classList.add('bounce');
      if (wrapper) {
        wrapper.style.transform = 'scale(1)';
      }
      
      setTimeout(() => {
        checkbox.classList.remove('clicked', 'bounce');
      }, 150);
    }, 100);

    console.log(`‚úÖ –ö–∞—Å—Ç–æ–º –æ—Ç–º–µ—Ç–∫–∞: —Å–ø–æ—Ä—Ç—Å–º–µ–Ω ${athleteId}, —Å–µ—Å—Å–∏—è ${sessionId}, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ: ${newState}`);
  }

  toggleAttendance(sessionId, athleteId, element) {
    const checkbox = element.querySelector('.attendance-checkbox');
    
    if (!checkbox) {
      console.error('‚ùå –ß–µ–∫–±–æ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ CSS –∫–ª–∞—Å—Å—É
    const isEditMode = document.querySelector('.journal-container.edit-mode') !== null;
    
    console.log('üî• toggleAttendance:', {
      sessionId,
      athleteId,
      editMode: isEditMode,
      currentChecked: checkbox.checked
    });
    
    // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (!isEditMode) {
      this.showNotification('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏', 'warning');
      return;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ü–û–õ–ù–´–ú –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
    const newState = !checkbox.checked;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
    checkbox.classList.add('clicked');
    element.style.transform = 'scale(0.95)';
    
    // –û–ë–ù–û–í–õ–Ø–ï–ú –í–°–ï –í–û–ó–ú–û–ñ–ù–´–ï –ê–¢–†–ò–ë–£–¢–´
    checkbox.checked = newState;
    
    if (newState) {
      // –°—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É
      checkbox.setAttribute('checked', 'checked');
      checkbox.classList.add('force-checked');
      checkbox.style.setProperty('background', '#4CAF50', 'important');
      checkbox.style.setProperty('border-color', '#4CAF50', 'important');
    } else {
      // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
      checkbox.removeAttribute('checked');
      checkbox.classList.remove('force-checked');
      checkbox.style.setProperty('background', 'white', 'important');
      checkbox.style.setProperty('border-color', '#ddd', 'important');
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç
    this.context.addChange(sessionId, athleteId, newState);

    // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç—Å–∫–æ–∫–∞
    setTimeout(() => {
      checkbox.classList.add('bounce');
      element.style.transform = 'scale(1)';
      
      setTimeout(() => {
        checkbox.classList.remove('clicked', 'bounce');
      }, 150);
    }, 100);

    console.log(`‚úÖ –û—Ç–º–µ—Ç–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ): —Å–ø–æ—Ä—Ç—Å–º–µ–Ω ${athleteId}, —Å–µ—Å—Å–∏—è ${sessionId}, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ: ${newState}`);
  }

  async saveChanges() {
    const changes = Array.from(this.context.state.changes.values());
    
    if (changes.length === 0) {
      this.showNotification('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'warning');
      return;
    }

    this.context.setLoading(true);

    try {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      formData.append('action', 'bulk_update_attendance');
      formData.append('edit_mode', this.context.state.editMode ? '1' : '0');
      formData.append('changes', JSON.stringify(changes));

      console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', changes.length, '–∏–∑–º–µ–Ω–µ–Ω–∏–π...');

      const response = await fetch(window.location.href, {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        this.context.clearChanges();
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–•–û–î –í –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê
        this.exitEditMode();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        this.showNotification(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.updated_count} –∑–∞–ø–∏—Å–µ–π`, 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        setTimeout(() => {
          this.showModeNotification('view');
        }, 1500);
        
        console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
      } else {
        this.showNotification(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data.error);
      }
    } catch (error) {
      this.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    } finally {
      this.context.setLoading(false);
    }
  }



  exitEditMode() {
    console.log('üîç –í—ã—Ö–æ–¥ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å edit-mode —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const container = document.querySelector('.journal-container');
    if (container) {
      container.classList.remove('edit-mode');
    }
    
    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editModeIndicator = document.querySelector('.edit-mode-indicator');
    if (editModeIndicator) {
      editModeIndicator.remove();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editBtn = document.getElementById('edit-mode-btn');
    if (editBtn) {
      editBtn.style.display = 'inline-flex';
    }
    
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ URL –±–µ–∑ edit=1
    const url = new URL(window.location);
    url.searchParams.delete('edit');
    window.history.replaceState({}, '', url);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    this.context.state.editMode = false;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    this.updateUI(this.context.state);
    
    console.log('‚úÖ –í—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∂–∏–º–µ
  showModeNotification(mode) {
    const message = mode === 'edit' ? 
      '‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å' : 
      'üëÅÔ∏è –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π';
    
    this.showNotification(message, mode === 'edit' ? 'warning' : 'success');
  }

  showNotification(message, type = 'info') {
    const notification = this.elements.notification;
    
    if (!notification) {
      console.log('üì¢ Notification:', message);
      return;
    }
    
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');

    setTimeout(() => {
      notification.classList.remove('show');
    }, 4000);
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
window.UnifiedJournal = null;

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
function navigateToMonth(value) {
  const [year, month] = value.split('-');
  const editParam = window.UnifiedJournal && window.UnifiedJournal.context.state.editMode ? '&edit=1' : '';
  window.location.href = `?year=${year}&month=${month}${editParam}`;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', function() {
  try {
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    window.UnifiedJournal = new UnifiedJournalApp();
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –Ω–∞–ª–∏—á–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    const editModeIndicator = document.querySelector('.edit-mode-indicator');
    if (editModeIndicator) {
      window.UnifiedJournal.context.state.editMode = true;
      console.log('üî• –ù–∞–π–¥–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      setTimeout(() => {
        window.UnifiedJournal.showModeNotification('edit');
      }, 1000);
    } else {
      console.log('üî• –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ù–ï –Ω–∞–π–¥–µ–Ω');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      setTimeout(() => {
        window.UnifiedJournal.showModeNotification('view');
      }, 1000);
    }
    
    console.log('‚úÖ –ñ—É—Ä–Ω–∞–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', window.UnifiedJournal.context.state.editMode);
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      console.log('üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã:');
      console.log('üî• Edit mode:', window.UnifiedJournal.context.state.editMode);
      console.log('üî• –ß–µ–∫–±–æ–∫—Å—ã:', document.querySelectorAll('.attendance-checkbox').length);
      console.log('üî• Wrappers:', document.querySelectorAll('.attendance-checkbox-wrapper').length);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞
      const firstCheckbox = document.querySelector('.attendance-checkbox');
      if (firstCheckbox) {
        console.log('üî• –ü–µ—Ä–≤—ã–π —á–µ–∫–±–æ–∫—Å:', {
          checked: firstCheckbox.checked,
          disabled: firstCheckbox.disabled,
          hasAttribute: firstCheckbox.hasAttribute('checked')
        });
      }
    }, 2000);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    return;
  }
});
</script>

{% endblock %}
