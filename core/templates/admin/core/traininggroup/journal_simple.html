{% extends "admin/base_site.html" %}
{% load custom_filters %}

{% block extrastyle %}
<style>
/* Простые стили для кликабельных ячеек */
.attendance-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.attendance-table th,
.attendance-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

.attendance-table th {
  background: #f5f5f5;
}

.athlete-name {
  text-align: left;
  font-weight: bold;
  min-width: 150px;
}

/* ГЛАВНОЕ - кликабельные ячейки */
.clickable-cell {
  cursor: pointer;
  width: 50px;
  height: 50px;
  font-size: 20px;
  background: #fff;
  transition: all 0.2s;
  user-select: none;
}

.clickable-cell:hover {
  background: #e8f5e8;
  transform: scale(1.1);
}

.clickable-cell.present {
  color: #4CAF50;
}

.clickable-cell.absent {
  color: #f44336;
}

.status-info {
  margin: 20px 0;
  padding: 10px;
  background: #f0f8ff;
  border-radius: 5px;
  text-align: center;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<h1>{{ title }} - ПРОСТАЯ ВЕРСИЯ</h1>
<p><a href="{% url 'admin:core_traininggroup_panel' group.pk %}">← Назад к группе</a></p>

<div class="status-info">
  <strong>Инструкция:</strong> Кликайте по ячейкам в таблице чтобы изменить посещаемость
  <br>
  <span id="changes-info">Изменений: 0</span>
  <button onclick="saveChanges()" style="margin-left: 20px; padding: 5px 15px;">Сохранить</button>
</div>

<table class="attendance-table">
  <thead>
    <tr>
      <th class="athlete-name">Спортсмен</th>
      {% for session in sessions %}
      <th>
        {{ session.date|date:"d.m" }}<br>
        <small>{{ session.start_time }}</small>
      </th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for athlete in children %}
    <tr>
      <td class="athlete-name">{{ athlete.last_name }} {{ athlete.first_name }}</td>
      {% for session in sessions %}
      {% with session_present=present|lookup:session.id %}
      <td class="clickable-cell {% if session_present and athlete.id in session_present %}present{% else %}absent{% endif %}"
          data-session="{{ session.id }}"
          data-athlete="{{ athlete.id }}"
          data-present="{% if session_present and athlete.id in session_present %}true{% else %}false{% endif %}"
          onclick="toggleCell(this)">
        {% if session_present and athlete.id in session_present %}✅{% else %}❌{% endif %}
      </td>
      {% endwith %}
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
let changes = [];

function toggleCell(cell) {
  console.log('Клик по ячейке!');
  
  const sessionId = cell.dataset.session;
  const athleteId = cell.dataset.athlete;
  const isPresent = cell.dataset.present === 'true';
  const newPresent = !isPresent;
  
  // Обновляем ячейку
  cell.dataset.present = newPresent.toString();
  cell.textContent = newPresent ? '✅' : '❌';
  cell.className = `clickable-cell ${newPresent ? 'present' : 'absent'}`;
  
  // Сохраняем изменение
  const changeKey = `${sessionId}_${athleteId}`;
  const existingIndex = changes.findIndex(c => c.key === changeKey);
  
  if (existingIndex >= 0) {
    changes[existingIndex] = {
      key: changeKey,
      session_id: parseInt(sessionId),
      athlete_id: parseInt(athleteId),
      present: newPresent
    };
  } else {
    changes.push({
      key: changeKey,
      session_id: parseInt(sessionId),
      athlete_id: parseInt(athleteId),
      present: newPresent
    });
  }
  
  // Обновляем счетчик
  document.getElementById('changes-info').textContent = `Изменений: ${changes.length}`;
  
  console.log('Изменение сохранено:', {sessionId, athleteId, newPresent});
}

function saveChanges() {
  if (changes.length === 0) {
    alert('Нет изменений для сохранения');
    return;
  }
  
  console.log('Сохранение изменений:', changes);
  
  const formData = new FormData();
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
  formData.append('action', 'bulk_update_attendance');
  formData.append('changes', JSON.stringify(changes));
  
  fetch(window.location.href, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`✅ Сохранено ${data.updated_count} записей`);
      changes = [];
      document.getElementById('changes-info').textContent = 'Изменений: 0';
    } else {
      alert(`❌ Ошибка: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Ошибка:', error);
    alert('❌ Ошибка сохранения');
  });
}

// Проверка загрузки
console.log('Простая версия журнала загружена');
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM загружен, ячеек найдено:', document.querySelectorAll('.clickable-cell').length);
});
</script>

{% endblock %}
