{% extends "admin/base_site.html" %}
{% load custom_filters %}

{% block extrastyle %}
<style>
/* –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —è—á–µ–µ–∫ */
.attendance-table {
  width: 100%;
    border-collapse: collapse;
  margin: 20px 0;
}

.attendance-table th,
.attendance-table td {
  border: 1px solid #ddd;
  padding: 6px;
    text-align: center;
  font-size: 13px;
}

.attendance-table th {
  background: #f5f5f5;
  font-size: 11px;
  padding: 8px 4px;
}

.athlete-name {
    text-align: left;
  font-weight: bold;
  min-width: 140px;
  font-size: 12px;
  padding: 8px 10px;
}

/* –ì–õ–ê–í–ù–û–ï - –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —è—á–µ–π–∫–∏ */
.clickable-cell {
    cursor: pointer;
  width: 35px;
  height: 35px;
  font-size: 16px;
  background: #fff;
  transition: all 0.2s;
    user-select: none;
  vertical-align: middle;
  }
  
.clickable-cell:hover {
  background: #e8f5e8;
    transform: scale(1.05);
  border: 2px solid #4CAF50;
}

.clickable-cell.present {
  color: #4CAF50;
  background: rgba(76, 175, 80, 0.1);
}

.clickable-cell.absent {
  color: #f44336;
  background: rgba(244, 67, 54, 0.05);
}

.status-info {
  margin: 15px 0;
  padding: 8px 12px;
  background: #f0f8ff;
  border-radius: 5px;
  text-align: center;
  font-size: 13px;
  border: 1px solid #d1ecf1;
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<h1>{{ title }} - –ü–†–û–°–¢–ê–Ø –í–ï–†–°–ò–Ø</h1>
<p><a href="{% url 'admin:core_traininggroup_panel' group.pk %}">‚Üê –ù–∞–∑–∞–¥ –∫ –≥—Ä—É–ø–ø–µ</a></p>

<div class="status-info">
  <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ —è—á–µ–π–∫–∞–º –≤ —Ç–∞–±–ª–∏—Ü–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
  <br>
  <span id="changes-info" style="font-weight: bold; color: #666;">–ò–∑–º–µ–Ω–µ–Ω–∏–π: 0</span>
  <button onclick="saveChanges()" style="margin-left: 15px; padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<table class="attendance-table">
  <thead>
    <tr>
      <th class="athlete-name">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</th>
      {% for session in sessions %}
       <th style="min-width: 45px;">
         <div style="font-weight: bold; margin-bottom: 2px;">{{ session.date|date:"d.m" }}</div>
         <div style="font-size: 9px; color: #666;">{{ session.start_time|time:"H:i" }}</div>
        </th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for athlete in children %}
      <tr>
      <td class="athlete-name">{{ athlete.last_name }} {{ athlete.first_name }}</td>
        {% for session in sessions %}
          {% with session_present=present|lookup:session.id %}
      <td class="clickable-cell {% if session_present and athlete.id in session_present %}present{% else %}absent{% endif %}"
          data-session="{{ session.id }}"
          data-athlete="{{ athlete.id }}"
          data-present="{% if session_present and athlete.id in session_present %}true{% else %}false{% endif %}"
          onclick="toggleCell(this)">
                    {% if session_present and athlete.id in session_present %}‚úÖ{% else %}‚ùå{% endif %}
          </td>
          {% endwith %}
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
let changes = [];

function toggleCell(cell) {
  console.log('–ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ!');
  
  const sessionId = cell.dataset.session;
  const athleteId = cell.dataset.athlete;
  const isPresent = cell.dataset.present === 'true';
  const newPresent = !isPresent;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É
  cell.dataset.present = newPresent.toString();
  cell.textContent = newPresent ? '‚úÖ' : '‚ùå';
  cell.className = `clickable-cell ${newPresent ? 'present' : 'absent'}`;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  const changeKey = `${sessionId}_${athleteId}`;
  const existingIndex = changes.findIndex(c => c.key === changeKey);
  
  if (existingIndex >= 0) {
    changes[existingIndex] = {
      key: changeKey,
      session_id: parseInt(sessionId),
      athlete_id: parseInt(athleteId),
      present: newPresent
    };
    } else {
    changes.push({
      key: changeKey,
      session_id: parseInt(sessionId),
      athlete_id: parseInt(athleteId),
      present: newPresent
    });
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
  document.getElementById('changes-info').textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–π: ${changes.length}`;
  
  console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', {sessionId, athleteId, newPresent});
}

function saveChanges() {
  if (changes.length === 0) {
    alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    return;
  }
  
  console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', changes);
  
    const formData = new FormData();
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('action', 'bulk_update_attendance');
  formData.append('changes', JSON.stringify(changes));
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
      alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.updated_count} –∑–∞–ø–∏—Å–µ–π`);
      changes = [];
      document.getElementById('changes-info').textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏–π: 0';
        } else {
      alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
console.log('–ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –∂—É—Ä–Ω–∞–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, —è—á–µ–µ–∫ –Ω–∞–π–¥–µ–Ω–æ:', document.querySelectorAll('.clickable-cell').length);
});
</script>

{% endblock %}
